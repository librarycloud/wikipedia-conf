 #  wikipedia to www.wikipedia
    server {
    server_name wikipedia.{$domain2}.{$domain1};
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
         ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
    }
   rewrite ^ https://www.wikipedia.{$domain2}.{$domain1}$request_uri;
   }


 # all languages wikipedia
    server {
    server_name  ~^(?<subdomain>[^.]+)\.wikipedia\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;

    ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
     if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
       }
    
    if ($http_x_forwarded_proto = 'http')
     {
        return 301 https://$subdomain.wikipedia.{$domain2}.{$domain1}$request_uri;
     }

    location / {
        proxy_pass https://$subdomain.wikipedia.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikipedia.org/ https://$subdomain.wikipedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikipedia.org/ https://$subdomain.m.wikipedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikipedia.org wikipedia.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};

        proxy_redirect ~^https://([\w\.]+).wikipedia.org/(.*?)$ https://$1.wikipedia.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;

        proxy_set_header       Host $subdomain.wikipedia.org;

        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             "wikisource.org" "wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";




     }

    server {
    server_name ~^(?<subdomain>[^.]+)\.m\.wikipedia\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
    ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
    }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 $https://subdomain.m.wikipedia.{$domain2}.{$domain1}$request_uri;
    }

    location / {
        proxy_pass https://$subdomain.m.wikipedia.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikipedia.org/ https://$subdomain.wikipedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikipedia.org/ https://$subdomain.m.wikipedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikipedia.org wikipedia.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};

        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;

        proxy_set_header       Host $subdomain.m.wikipedia.org;

        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;


        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";


        
        
    }
 # wikimedia
    server {
    server_name  wikimedia.{$domain2}.{$domain1};
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
    ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
       }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 https://wikimedia.{$domain2}.{$domain1}$request_uri;
     }
    location / {
        proxy_pass https://wikimedia.org;
        proxy_buffering off;

        proxy_redirect https://wikimedia.org/ https://wikimedia.{$domain2}.{$domain1}/;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ https://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;


        proxy_set_header       Host wikimedia.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";

        
     
    }

 #  wikimedia
    server {
    server_name  ~^(?<subdomain>[^.]+)\.wikimedia\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
    ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
       }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 https://$subdomain.wikimedia.{$domain2}.{$domain1}$request_uri;
    }

    location / {
        proxy_pass https://$subdomain.wikimedia.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ https://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikipedia.org wikipedia.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};
        proxy_cookie_domain             wmfusercontent.org wmfusercontent.{$domain2}.{$domain1};
        proxy_cookie_domain             wikimediafoundation.org wikimediafoundation.{$domain2}.{$domain1};
        proxy_cookie_domain             wiktionary.org wiktionary.{$domain2}.{$domain1};
        proxy_cookie_domain             wikivoyage.org wikivoyage.{$domain2}.{$domain1};
        proxy_cookie_domain             wikiversity.org wikiversity.{$domain2}.{$domain1};
        proxy_cookie_domain             wikisource.org wikisource.{$domain2}.{$domain1};
        proxy_cookie_domain             wikiquote.org wikiquote.{$domain2}.{$domain1};
        proxy_cookie_domain             wikinews.org wikinews.{$domain2}.{$domain1};
        proxy_cookie_domain             wikidata.org wikidata.{$domain2}.{$domain1};
        proxy_cookie_domain             wikibooks.org wikibooks.{$domain2}.{$domain1};
        proxy_cookie_domain             mediawiki.org mediawiki.{$domain2}.{$domain1};

        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikipedia.org/(.*?)$ https://$1.wikipedia.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wmfusercontent.org/(.*?)$ https://$1.wmfusercontent.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimediafoundation.org/(.*?)$ https://$1.wikimediafoundation.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wiktionary.org/(.*?)$ https://$1.wiktionary.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikivoyage.org/(.*?)$ https://$1.wikivoyage.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikiversity.org/(.*?)$ https://$1.wikiversity.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikisource.org/(.*?)$ https://$1.wikisource.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikiquote.org/(.*?)$ https://$1.wikiquote.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikinews.org/(.*?)$ https://$1.wikinews.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikidata.org/(.*?)$ https://$1.wikidata.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikibooks.org/(.*?)$ https://$1.wikibooks.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).mediawiki.org/(.*?)$ https://$1.mediawiki.{$domain2}.{$domain1}/$2;

        proxy_set_header       Host $subdomain.wikimedia.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";


        
     
    }

    server {
    server_name ~^(?<subdomain>[^.]+)\.m\.wikimedia\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
   ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
    }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 $subdomain.m.wikimedia.{$domain2}.{$domain1}$request_uri;
    }

    location / {
        proxy_pass https://$subdomain.m.wikimedia.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ http://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikipedia.org wikipedia.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};
        proxy_cookie_domain             wmfusercontent.org wmfusercontent.{$domain2}.{$domain1};
        proxy_cookie_domain             wikimediafoundation.org wikimediafoundation.{$domain2}.{$domain1};
        proxy_cookie_domain             wiktionary.org wiktionary.{$domain2}.{$domain1};
        proxy_cookie_domain             wikivoyage.org wikivoyage.{$domain2}.{$domain1};
        proxy_cookie_domain             wikiversity.org wikiversity.{$domain2}.{$domain1};
        proxy_cookie_domain             wikisource.org wikisource.{$domain2}.{$domain1};
        proxy_cookie_domain             wikiquote.org wikiquote.{$domain2}.{$domain1};
        proxy_cookie_domain             wikinews.org wikinews.{$domain2}.{$domain1};
        proxy_cookie_domain             wikidata.org wikidata.{$domain2}.{$domain1};
        proxy_cookie_domain             wikibooks.org wikibooks.{$domain2}.{$domain1};
        proxy_cookie_domain             mediawiki.org mediawiki.{$domain2}.{$domain1};

        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikipedia.org/(.*?)$ https://$1.wikipedia.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wmfusercontent.org/(.*?)$ https://$1.wmfusercontent.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimediafoundation.org/(.*?)$ https://$1.wikimediafoundation.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wiktionary.org/(.*?)$ https://$1.wiktionary.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikivoyage.org/(.*?)$ https://$1.wikivoyage.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikiversity.org/(.*?)$ https://$1.wikiversity.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikisource.org/(.*?)$ https://$1.wikisource.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikiquote.org/(.*?)$ https://$1.wikiquote.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikinews.org/(.*?)$ https://$1.wikinews.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikidata.org/(.*?)$ https://$1.wikidata.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikibooks.org/(.*?)$ https://$1.wikibooks.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).mediawiki.org/(.*?)$ https://$1.mediawiki.{$domain2}.{$domain1}/$2;

        proxy_set_header       Host $subdomain.m.wikimedia.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";


        
    }


 # wiktionary
    server {
    server_name  ~^(?<subdomain>[^.]+)\.wiktionary\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
    ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
       }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 https://$subdomain.wiktionary.{$domain2}.{$domain1}$request_uri;
    }

    location / {
        proxy_pass https://$subdomain.wiktionary.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ https://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wiktionary.org wiktionary.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};


        proxy_redirect ~^https://([\w\.]+).wiktionary.org/(.*?)$ https://$1.wiktionary.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;


        proxy_set_header       Host $subdomain.wiktionary.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";



        
    }

    server {
    server_name ~^(?<subdomain>[^.]+)\.m\.wiktionary\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
   ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
    }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 $subdomain.m.wiktionary.{$domain2}.{$domain1}$request_uri;
    }

    location / {
        proxy_pass https://$subdomain.m.wiktionary.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ http://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wiktionary.org wiktionary.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};

        proxy_redirect ~^https://([\w\.]+).wiktionary.org/(.*?)$ https://$1.wiktionary.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;

        proxy_set_header       Host $subdomain.m.wiktionary.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";



        
    }

 
 # wikisource homepage
    server {
    server_name  wikisource.{$domain2}.{$domain1} www.wikisource.{$domain2}.{$domain1};
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
    ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
       }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 https://wikisource.{$domain2}.{$domain1}$request_uri;
     }
    location / {
        proxy_pass https://wikisource.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ https://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikisource.org wikisource.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};

        proxy_redirect https://wikisource.org/ https://wikisource.{$domain2}.{$domain1}/;
        proxy_redirect https://m.wikisource.org/ https://m.wikisource.{$domain2}.{$domain1}/;

        proxy_redirect ~^https://([\w\.]+).wikisource.org/(.*?)$ https://$1.wikisource.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;


        proxy_set_header       Host wikisource.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";

        
    }

 
 # all languages wikisource
    server {
    server_name  ~^(?<subdomain>[^.]+)\.wikisource\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
    ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
       }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 https://$subdomain.wikisource.{$domain2}.{$domain1}$request_uri;
     }

    location / {
        proxy_pass https://$subdomain.wikisource.org;
        proxy_buffering off;

        proxy_redirect https://wikisource.org/ https://wikisource.{$domain2}.{$domain1}/;
        proxy_redirect https://m.wikisource.org/ https://m.wikisource.{$domain2}.{$domain1}/;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ https://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikisource.org wikisource.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};


        proxy_redirect ~^https://([\w\.]+).wikisource.org/(.*?)$ https://$1.wikisource.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;


        proxy_set_header       Host $subdomain.wikisource.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";



        
    }

    server {
    server_name ~^(?<subdomain>[^.]+)\.m\.wikisource\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
   ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
    }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 $subdomain.m.wikisource.{$domain2}.{$domain1}$request_uri;
    }

    location / {
        proxy_pass https://$subdomain.m.wikisource.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ http://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikisource.org wikisource.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};


        proxy_redirect ~^https://([\w\.]+).wikisource.org/(.*?)$ https://$1.wikisource.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;

        proxy_set_header       Host $subdomain.m.wikisource.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";



        
    }


 

 # wmfusercontent
    server {
    server_name  ~^(?<subdomain>[^.]+)\.wmfusercontent\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
    ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
       }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 https://$subdomain.wmfusercontent.{$domain2}.{$domain1}$request_uri;
     }

    location / {
        proxy_pass https://$subdomain.wmfusercontent.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ https://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wmfusercontent.org wmfusercontent.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};

        proxy_redirect ~^https://([\w\.]+).wmfusercontent.org/(.*?)$ https://$1.wmfusercontent.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;

        proxy_set_header       Host $subdomain.wmfusercontent.org;

        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";

        
    }

    server {
    server_name ~^(?<subdomain>[^.]+)\.m\.wmfusercontent\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
   ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
    }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 $subdomain.m.wmfusercontent.{$domain2}.{$domain1}$request_uri;
    }

    location / {
        proxy_pass https://$subdomain.m.wmfusercontent.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ http://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wmfusercontent.org wmfusercontent.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};

        proxy_redirect ~^https://([\w\.]+).wmfusercontent.org/(.*?)$ https://$1.wmfusercontent.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;

        proxy_set_header       Host $subdomain.m.wmfusercontent.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";

        
    }

 # wikimediafoundation homepage
    server {
    server_name  wikimediafoundation.{$domain2}.{$domain1} www.wikimediafoundation.{$domain2}.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
    ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
       }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 https://wikimediafoundation.{$domain2}.{$domain1}$request_uri;
     }
    location / {
        proxy_pass https://wikimediafoundation.org;
        proxy_buffering off;

        proxy_redirect https://wikimediafoundation.org/ https://wikimediafoundation.{$domain2}.{$domain1}/;
        proxy_redirect https://m.wikimediafoundation.org/ https://m.wikimediafoundation.{$domain2}.{$domain1}/;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ https://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikimediafoundation.org wikimediafoundation.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};


        proxy_redirect ~^https://([\w\.]+).wikimediafoundation.org/(.*?)$ https://$1.wikimediafoundation.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;


        proxy_set_header       Host wikimediafoundation.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";

        
    }

 # wikimediafoundation
    server {
    server_name  ~^(?<subdomain>[^.]+)\.wikimediafoundation\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
    ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
       }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 https://$subdomain.wikimediafoundation.{$domain2}.{$domain1}$request_uri;
     }

    location / {
        proxy_pass https://$subdomain.wikimediafoundation.org;
        proxy_buffering off;

        proxy_redirect https://wikimediafoundation.org/ https://wikimediafoundation.{$domain2}.{$domain1}/;
        proxy_redirect https://m.wikimediafoundation.org/ https://m.wikimediafoundation.{$domain2}.{$domain1}/;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ https://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikimediafoundation.org wikimediafoundation.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};

        proxy_redirect ~^https://([\w\.]+).wikimediafoundation.org/(.*?)$ https://$1.wikimediafoundation.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;



        proxy_set_header       Host $subdomain.wikimediafoundation.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";

        
    }

    server {
    server_name ~^(?<subdomain>[^.]+)\.m\.wikimediafoundation\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
   ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
    }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 $subdomain.m.wikimediafoundation.{$domain2}.{$domain1}$request_uri;
    }

    location / {
        proxy_pass https://$subdomain.m.wikimediafoundation.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ http://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikimediafoundation.org wikimediafoundation.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};


        proxy_redirect ~^https://([\w\.]+).wikimediafoundation.org/(.*?)$ https://$1.wikimediafoundation.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;

        proxy_set_header       Host $subdomain.m.wikimediafoundation.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";

        
    }



 # wikivoyage
    server {
    server_name  ~^(?<subdomain>[^.]+)\.wikivoyage\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
    ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
       }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 https://$subdomain.wikivoyage.{$domain2}.{$domain1}$request_uri;
     }

    location / {
        proxy_pass https://$subdomain.wikivoyage.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ https://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikivoyage.org wikivoyage.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};


        proxy_redirect ~^https://([\w\.]+).wikivoyage.org/(.*?)$ https://$1.wikivoyage.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;


        proxy_set_header       Host $subdomain.wikivoyage.org;

        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";


        
    }

    server {
    server_name ~^(?<subdomain>[^.]+)\.m\.wikivoyage\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
   ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
    }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 $subdomain.m.wikivoyage.{$domain2}.{$domain1}$request_uri;
    }

    location / {
        proxy_pass https://$subdomain.m.wikivoyage.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ http://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikivoyage.org wikivoyage.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};

        proxy_redirect ~^https://([\w\.]+).wikivoyage.org/(.*?)$ https://$1.wikivoyage.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;


        proxy_set_header       Host $subdomain.wikivoyage.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";



        
    }
    
 # wikiversity
    server {
    server_name  ~^(?<subdomain>[^.]+)\.wikiversity\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
    ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
       }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 https://$subdomain.wikiversity.{$domain2}.{$domain1}$request_uri;
     }

    location / {
        proxy_pass https://$subdomain.wikiversity.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ https://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikiversity.org wikiversity.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};

        proxy_redirect ~^https://([\w\.]+).wikiversity.org/(.*?)$ https://$1.wikiversity.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;



        proxy_set_header       Host $subdomain.wikiversity.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";

        
    }

    server {
    server_name ~^(?<subdomain>[^.]+)\.m\.wikiversity\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
   ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
    }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 $subdomain.m.wikiversity.{$domain2}.{$domain1}$request_uri;
    }

    location / {
        proxy_pass https://$subdomain.m.wikiversity.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ http://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikiversity.org wikiversity.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};

        proxy_redirect ~^https://([\w\.]+).wikiversity.org/(.*?)$ https://$1.wikiversity.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;

        proxy_set_header       Host $subdomain.m.wikiversity.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";


        
    }
    
 # wikiquote
    server {
    server_name  ~^(?<subdomain>[^.]+)\.wikiquote\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
    ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
       }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 https://$subdomain.wikiquote.{$domain2}.{$domain1}$request_uri;
     }

    location / {
        proxy_pass https://$subdomain.wikiquote.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ https://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikiquote.org wikiquote.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};


        proxy_redirect ~^https://([\w\.]+).wikiquote.org/(.*?)$ https://$1.wikiquote.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;


        proxy_set_header       Host $subdomain.wikiquote.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";


        
    }

    server {
    server_name ~^(?<subdomain>[^.]+)\.m\.wikiquote\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
   ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
    }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 $subdomain.m.wikiquote.{$domain2}.{$domain1}$request_uri;
    }

    location / {
        proxy_pass https://$subdomain.m.wikiquote.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ http://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikiquote.org wikiquote.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};

        proxy_redirect ~^https://([\w\.]+).wikiquote.org/(.*?)$ https://$1.wikiquote.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;

        proxy_set_header       Host $subdomain.m.wikiquote.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";



        
    }
    
 # wikinews
    server {
    server_name  ~^(?<subdomain>[^.]+)\.wikinews\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
    ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
       }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 https://$subdomain.wikinews.{$domain2}.{$domain1}$request_uri;
     }

    location / {
        proxy_pass https://$subdomain.wikinews.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ https://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikinews.org wikinews.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};


        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikinews.org/(.*?)$ https://$1.wikinews.{$domain2}.{$domain1}/$2;


        proxy_set_header       Host $subdomain.wikinews.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";


        
    }

    server {
    server_name ~^(?<subdomain>[^.]+)\.m\.wikinews\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
   ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
    }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 $subdomain.m.wikinews.{$domain2}.{$domain1}$request_uri;
    }

    location / {
        proxy_pass https://$subdomain.m.wikinews.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ http://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikinews.org wikinews.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};

        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikinews.org/(.*?)$ https://$1.wikinews.{$domain2}.{$domain1}/$2;

        proxy_set_header       Host $subdomain.m.wikinews.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";


        
    }
    
 # wikidata
    server {
    server_name  ~^(?<subdomain>[^.]+)\.wikidata\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
    ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
       }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 https://$subdomain.wikidata.{$domain2}.{$domain1}$request_uri;
     }

    location / {
        proxy_pass https://$subdomain.wikidata.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ https://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikidata.org wikidata.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};


        proxy_redirect ~^https://([\w\.]+).wikidata.org/(.*?)$ https://$1.wikidata.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;


        proxy_set_header       Host $subdomain.wikidata.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";


        
    }

    server {
    server_name ~^(?<subdomain>[^.]+)\.m\.wikidata\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
   ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
    }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 $subdomain.m.wikidata.{$domain2}.{$domain1}$request_uri;
    }

    location / {
        proxy_pass https://$subdomain.m.wikidata.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ http://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikidata.org wikidata.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};


        proxy_redirect ~^https://([\w\.]+).wikidata.org/(.*?)$ https://$1.wikidata.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;

        proxy_set_header       Host $subdomain.m.wikidata.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";


        
    }
    
 # wikibooks
    server {
    server_name  ~^(?<subdomain>[^.]+)\.wikibooks\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
    ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
       }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 https://$subdomain.wikibooks.{$domain2}.{$domain1}$request_uri;
     }

    location / {
        proxy_pass https://$subdomain.wikibooks.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ https://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikibooks.org wikibooks.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};


        proxy_redirect ~^https://([\w\.]+).wikibooks.org/(.*?)$ https://$1.wikibooks.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;

        proxy_set_header       Host $subdomain.wikibooks.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";


        
    }

    server {
    server_name ~^(?<subdomain>[^.]+)\.m\.wikibooks\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
   ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
    }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 $subdomain.m.wikibooks.{$domain2}.{$domain1}$request_uri;
    }

    location / {
        proxy_pass https://$subdomain.m.wikibooks.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ http://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain wikibooks.org wikibooks.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};


        proxy_redirect ~^https://([\w\.]+).wikibooks.org/(.*?)$ https://$1.wikibooks.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;

        proxy_set_header       Host $subdomain.m.wikibooks.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";


        
    }
    
 # mediawiki
    server {
    server_name  ~^(?<subdomain>[^.]+)\.mediawiki\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
    ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
       }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 https://$subdomain.mediawiki.{$domain2}.{$domain1}$request_uri;
     }

    location / {
        proxy_pass https://$subdomain.mediawiki.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ https://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain mediawiki.org mediawiki.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};


        proxy_redirect ~^https://([\w\.]+).mediawiki.org/(.*?)$ https://$1.mediawiki.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;

        proxy_set_header       Host $subdomain.mediawiki.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";


        
    }

    server {
    server_name ~^(?<subdomain>[^.]+)\.m\.mediawiki\.{$domain2}\.{$domain1}$;
    listen 80;
    listen 443 ssl http2;
    resolver 8.8.8.8;
   ssl_certificate /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/fullchain.cer;
        ssl_certificate_key /usr/local/nginx/conf/ssl/*.{$domain2}.{$domain1}/*.{$domain2}.{$domain1}.key;
        ssl_session_timeout 5m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";
        ssl_session_cache builtin:1000 shared:SSL:10m;
        # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048
        ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;
    #阻止搜索引擎蜘蛛收录站点，在下个 server 中也需加入。
    if ($http_user_agent ~* "Bot|Spider|Barkrowler|BingPreview|Feedfetcher-Google|ia_archiver|libwww-perl|MBCrawler|Mediapartners-Google|MSNot-media|Python|Teoma|Yahoo! Slurp|^$") {
        return 444;
    }
    
    if ($http_x_forwarded_proto = 'http')
    {
        return 301 $subdomain.m.mediawiki.{$domain2}.{$domain1}$request_uri;
    }

    location / {
        proxy_pass https://$subdomain.m.mediawiki.org;
        proxy_buffering off;

        proxy_redirect https://$subdomain.wikimedia.org/ https://$subdomain.wikimedia.{$domain2}.{$domain1}/;
        proxy_redirect https://$subdomain.m.wikimedia.org/ http://$subdomain.m.wikimedia.{$domain2}.{$domain1}/;
        proxy_cookie_domain mediawiki.org mediawiki.{$domain2}.{$domain1};
        proxy_cookie_domain wikimedia.org wikimedia.{$domain2}.{$domain1};

        proxy_redirect ~^https://([\w\.]+).mediawiki.org/(.*?)$ https://$1.mediawiki.{$domain2}.{$domain1}/$2;
        proxy_redirect ~^https://([\w\.]+).wikimedia.org/(.*?)$ https://$1.wikimedia.{$domain2}.{$domain1}/$2;

        proxy_set_header       Host $subdomain.m.mediawiki.org;
        proxy_set_header X-Real_IP $remote_addr;
        proxy_set_header User-Agent $http_user_agent;
        proxy_set_header Accept-Encoding ''; 
        proxy_set_header Referer $http_referer;

        sub_filter             ".wikimedia.org" ".wikimedia.{$domain2}.{$domain1}";
        sub_filter             ".wikipedia.org" ".wikipedia.{$domain2}.{$domain1}";
        sub_filter             ".wmfusercontent.org" ".wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             ".wikimediafoundation.org" ".wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             ".wiktionary.org" ".wiktionary.{$domain2}.{$domain1}";
        sub_filter             ".wikivoyage.org" ".wikivoyage.{$domain2}.{$domain1}";
        sub_filter             ".wikiversity.org" ".wikiversity.{$domain2}.{$domain1}";
        sub_filter             ".wikisource.org" ".wikisource.{$domain2}.{$domain1}";
        sub_filter             ".wikiquote.org" ".wikiquote.{$domain2}.{$domain1}";
        sub_filter             ".wikinews.org" ".wikinews.{$domain2}.{$domain1}";
        sub_filter             ".wikidata.org" ".wikidata.{$domain2}.{$domain1}";
        sub_filter             ".wikibooks.org" ".wikibooks.{$domain2}.{$domain1}";
        sub_filter             ".mediawiki.org" ".mediawiki.{$domain2}.{$domain1}";

        sub_filter             "//wikimedia.org" "//wikimedia.{$domain2}.{$domain1}";
        sub_filter             "//wikipedia.org" "//wikipedia.{$domain2}.{$domain1}";
        sub_filter             "//wmfusercontent.org" "//wmfusercontent.{$domain2}.{$domain1}";
        sub_filter             "//wikimediafoundation.org" "//wikimediafoundation.{$domain2}.{$domain1}";
        sub_filter             "//wiktionary.org" "//wiktionary.{$domain2}.{$domain1}";
        sub_filter             "//wikivoyage.org" "//wikivoyage.{$domain2}.{$domain1}";
        sub_filter             "//wikiversity.org" "//wikiversity.{$domain2}.{$domain1}";
        sub_filter             "//wikisource.org" "//wikisource.{$domain2}.{$domain1}";
        sub_filter             "//wikiquote.org" "//wikiquote.{$domain2}.{$domain1}";
        sub_filter             "//wikinews.org" "//wikinews.{$domain2}.{$domain1}";
        sub_filter             "//wikidata.org" "//wikidata.{$domain2}.{$domain1}";
        sub_filter             "//wikibooks.org" "//wikibooks.{$domain2}.{$domain1}";
        sub_filter             "//mediawiki.org" "//mediawiki.{$domain2}.{$domain1}";    
    }
    
